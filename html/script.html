<script lang="text/javascript">
  let host = "{{ .Host }}";
  let jsonObj = "{{ .JSON }}";
  let data = JSON.parse(jsonObj);
  let tool = "curl";
  let commandBox, widgetBox, compositePath, commandStr;
  let path
  let ipQuery, portQuery
  let ipCheckBox, portCheckBox, portInput
  let ip = ''

  window.onload = (event) => {
     commandBox = document.getElementById('command');
     widgetBox = document.getElementById('output');
     ipCheckBox = document.getElementById('ipCheckBox')
     portCheckBox = document.getElementById('portCheckBox')
     portInput = document.getElementById('portInput')
     reset()
     setcommdStr()
     changeInput("ip")
     loadBothIPs()
  }

  function loadBothIPs() {
    let ipv4 = null;
    let ipv6 = null;
    let completed = 0;
    
    function updateMainDisplay() {
      const mainDisplay = document.getElementById('main-ip-display');
      let html = '';
      
      if (ipv4 && ipv6) {
        // Hem IPv4 hem IPv6 var
        html = `
          <p><code class="ip">${ipv4}</code></p>
          <p><code class="ip">${ipv6}</code></p>
        `;
      } else if (ipv4) {
        // Sadece IPv4 var
        html = `<p><code class="ip">${ipv4}</code></p>`;
      } else if (ipv6) {
        // Sadece IPv6 var
        html = `<p><code class="ip">${ipv6}</code></p>`;
      } else {
        // Hiçbiri yok
        html = `<p><code class="ip">IP adresi bulunamadı</code></p>`;
      }
      
      mainDisplay.innerHTML = html;
    }
    
    // Load IPv4
    fetch('/ipv4')
      .then(response => response.text())
      .then(data => {
        const trimmed = data.trim();
        if (trimmed !== 'IPv4 address not available') {
          ipv4 = trimmed;
        }
        completed++;
        if (completed === 2) updateMainDisplay();
      })
      .catch(error => {
        completed++;
        if (completed === 2) updateMainDisplay();
      });
    
    // Load IPv6
    fetch('/ipv6')
      .then(response => response.text())
      .then(data => {
        const trimmed = data.trim();
        if (trimmed !== 'IPv6 address not available') {
          ipv6 = trimmed;
        }
        completed++;
        if (completed === 2) updateMainDisplay();
      })
      .catch(error => {
        completed++;
        if (completed === 2) updateMainDisplay();
      });
  }

  function reset() {
    path = '';
    ipQuery = '';
    portQuery = '';
  }

  function setcommdStr() {
    compositePath = `${path}${portQuery}${ipQuery}`;
    commandStr = `${tool} ${host}/${compositePath}`;
    commandBox.innerText = commandStr;
  }

  function changeInput(input, button) {
    path = input
    portQuery = ""
    portInput.classList.add("hidden");
    switch(path) {
      case "json":
        output.innerText = jsonObj
        break
      case "country-iso":
        output.innerText = data["country_iso"]
        break
      case "port":
        portInput.classList.remove("hidden");
        path = "port";
        output.innerText = "{}";
        let currentPort = document.querySelector("#portInput").value;
        updatePort(currentPort);
        break
      case "ip":
        output.innerText = data["ip"]
        path = ""
        break
      case "ipv4":
        fetchAndDisplay("ipv4")
        break
      case "ipv6":
        fetchAndDisplay("ipv6")
        break
      case "both":
        fetchAndDisplay("both")
        break
      default:
        output.innerText = data[path]
    }
    setcommdStr();

    // set button selected
    if (button) {
      allButtons = document.querySelectorAll(('button.selected'));
      allButtons.forEach((btn) => {btn.classList.remove("selected")})

      button.classList.add("selected");
    }
  }

  function navigate(event) {
    console.log("navigate", compositePath)
    window.location = compositePath
  }

  function updatePort(value) {
    port = value
    portQuery = `/${port}`
    setcommdStr()
  }

  function updateIP(value) {
    ip = value
    ipQuery = `?ip=${ip}`;
    setcommdStr()
    changeInput("ip", null)
  }



  function fetchAndDisplay(endpoint) {
    const url = `/${endpoint}${ipQuery}`;
    fetch(url)
      .then(response => response.text())
      .then(data => {
        output.innerText = data.trim();
      })
      .catch(error => {
        output.innerText = `Error: ${error.message}`;
      });
  }
</script>
